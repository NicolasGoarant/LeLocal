<script>
  (function () {
    window.NEEDS_DATA = <%= raw(
      @needs.map { |n|
        # Essaie de prendre la première photo si elle existe, sinon un placeholder
        image_url =
          if n.respond_to?(:photos) && n.photos.respond_to?(:attached?) && n.photos.attached?
            url_for(n.photos.first)
          else
            # Image par défaut (sécurisée pour prod)
            "https://images.unsplash.com/photo-1517457373958-b7bdd4587205?q=80&w=800&auto=format&fit=crop"
          end

        {
          id:   n.id,
          title:n.title,
          city: n.city,
          date: (n.date_needed.respond_to?(:strftime) ? n.date_needed.strftime('%d/%m/%Y') : n.date_needed),
          lat:  n.latitude,
          lng:  n.longitude,
          budget: (n.respond_to?(:budget) ? n.budget : nil),
          image: image_url,
          url:  (n.id.present? ? need_path(n.id) : "#")
        }
      }.to_json
    ) %>;
  })();
</script>


