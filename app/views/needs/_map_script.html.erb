<%# app/views/needs/_map_data.html.erb %>
<%
  data = (@needs || []).map do |n|
    # id prÃ©sent uniquement pour les besoins en BDD
    nid =
      if n.respond_to?(:id) && n.id.present?
        n.id
      else
        nil
      end

    # Titre / ville / date / budget
    ntitle = (n.respond_to?(:title) && n.title.present?) ? n.title : "Besoin d'espace"
    ncity  = (n.respond_to?(:city) && n.city.present?) ? n.city : nil
    ndate  =
      if n.respond_to?(:date_needed) && n.date_needed.present?
        begin
          l(n.date_needed, format: '%d/%m/%Y')
        rescue
          n.date_needed.to_s
        end
      else
        nil
      end
    nbudget = (n.respond_to?(:budget) && n.budget.present?) ? n.budget : nil

    # Coords
    nlat = n.respond_to?(:latitude) ? n.latitude : nil
    nlng = n.respond_to?(:longitude) ? n.longitude : nil

    # Image (photo jointe sinon fallback)
    nimage =
      begin
        if n.respond_to?(:photos) && n.photos.respond_to?(:attached?) && n.photos.attached?
          url_for(n.photos.first)
        else
          # Fallback image (remplace si tu as un asset local)
          "https://images.unsplash.com/photo-1517457373958-b7bdd4587205?q=80&w=800&auto=format&fit=crop"
        end
      rescue
        "https://images.unsplash.com/photo-1517457373958-b7bdd4587205?q=80&w=800&auto=format&fit=crop"
      end

    # URL uniquement si id valide
    nurl = nid ? need_path(nid) : nil

    {
      id: nid,
      title: ntitle,
      city: ncity,
      date: ndate,
      budget: nbudget,
      lat: nlat,
      lng: nlng,
      image: nimage,
      url: nurl
    }
  end
%>

<script>
  window.NEEDS_DATA = <%= raw(data.to_json) %>;
</script>

