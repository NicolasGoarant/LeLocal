<% content_for :scripts do %>
<script>
(function(){
  function initNeedsMap(){
    var el = document.getElementById('map');
    if (!el) return;
    if (el.dataset.initialized === '1') return;
    el.dataset.initialized = '1';

    var center = [<%= (@center_coords && @center_coords[0]) || 46.6 %>, <%= (@center_coords && @center_coords[1]) || 2.2 %>];
    var map = L.map('map', { scrollWheelZoom: true }).setView(center, 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    var ico = L.icon({
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25,41], iconAnchor:[12,41], popupAnchor:[1,-30], shadowSize:[41,41]
    });

    var b = [];
    (window.NEEDS_DATA || []).forEach(function(n){
      var html =
        '<div class="popup-content">' +
          '<img class="popup-image" src="'+ (n.image || '') +'">' +
          '<h3 class="popup-title">'+ n.title +'</h3>' +
          '<p class="popup-details">'+ (n.city || '') + (n.date ? ' • '+n.date : '') +'</p>' +
          '<p class="popup-budget">'+ (n.budget ? ('Budget : '+n.budget+'€') : 'Budget non spécifié') +'</p>' +
          '<a class="popup-link" href="'+ n.url +'">Voir le besoin</a>' +
        '</div>';

      L.marker([n.lat, n.lng], {icon: ico}).addTo(map).bindPopup(html);
      b.push([n.lat, n.lng]);
    });

    if (b.length) map.fitBounds(b, {padding:[30,30]}); else map.setView(center, 11);
  }

  document.addEventListener('turbo:load', initNeedsMap);
  document.addEventListener('DOMContentLoaded', initNeedsMap);
})();
</script>
<% end %>
