<%# app/views/spaces/show.html.erb %>
<% content_for :title, "LeLocal - #{@space.name}" %>

<%# ---------- Helpers ---------- %>
<%# Resolve category name robustly whether it's an association or a string column %>
<% cat_name =
     begin
       val = @space.try(:category)
       val.respond_to?(:name) ? val.name : (val.is_a?(String) ? val : @space.try(:[], :category))
     rescue
       nil
     end %>

<% content_for :head do %>
  <style>
    header { margin-bottom: 0 !important; }

    .container-page { max-width: 1100px; margin: 14px auto 48px; padding: 0 16px; }

    /* Hero limited to container */
    .hero-wrap { margin: 0 auto 16px; }
    .hero-box{
      height: 220px; border-radius: 14px; overflow: hidden; color:#fff;
      display:grid; align-items:end;
      background:
        linear-gradient(rgba(0,0,0,.28), rgba(0,0,0,.45)),
        url("<%= @space.photos.attached? ? url_for(@space.photos.first) : 'https://images.unsplash.com/photo-1600585154526-990dced4db0d?q=80&w=1600&auto=format&fit=crop' %>")
        center/cover no-repeat;
    }
    .hero-inner{ padding:18px; }
    .hero-title{ font-size: clamp(20px,3vw,28px); font-weight: 800; margin:0 0 6px; }
    .hero-meta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-size:14px; opacity:.98; }
    .chip { background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25);
            padding:4px 10px; border-radius:999px; font-size:12px; }

    .grid {
      display:grid; grid-template-columns: 1fr 320px; gap: 24px;
    }

    .card { background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .card-body{ padding:18px; }
    .section-title{ font-weight:700; font-size:16px; margin:2px 0 12px; color:#222; }
    .muted{ color:#666; font-size:13px; }

    /* Carousel */
    .gallery{ margin-bottom:16px; }
    .gallery-strip{
      display:flex; gap:10px; overflow-x:auto; scroll-snap-type:x mandatory; padding: 10px 6px;
    }
    .gallery-strip::-webkit-scrollbar{ height:8px; }
    .gallery-strip::-webkit-scrollbar-thumb{ background:#d1d5db; border-radius:999px; }
    .photo{
      flex: 0 0 260px; height: 160px; border-radius:12px; overflow:hidden;
      scroll-snap-align:start; background:#f3f4f6;
      box-shadow:0 4px 12px rgba(0,0,0,.06);
    }
    .photo img{ width:100%; height:100%; object-fit:cover; display:block; }

    /* Map */
    #space-map{ width:100%; height:320px; border-radius:10px; }

    /* Aside */
    .price{ font-size:24px; font-weight:800; color:#2e7d32; }

    .pill{ background:#f2f4f7; border:1px solid #e5e7eb; padding:6px 10px; border-radius:999px; font-size:13px; }
    .info-row{ display:flex; gap:8px; align-items:center; margin:2px 0; }
    .contact a{ color:#2e7d32; text-decoration:none; }
    .contact a:hover{ text-decoration:underline; }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; gap:16px; }
      .hero-box{ height: 200px; }
      #space-map{ height:260px; }
      .container-page{ margin-top: 8px; }
    }
  </style>
<% end %>

<div class="container-page">
  <!-- HERO (now inside the container and clipped) -->
  <div class="hero-wrap">
    <div class="hero-box">
      <div class="hero-inner">
        <h1 class="hero-title"><%= @space.name %></h1>
        <div class="hero-meta">
          <span><%= @space.address.presence || "Adresse non renseignée" %></span>
          <% if @space.capacity.present? %><span class="chip"><%= @space.capacity %> personnes max.</span><% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- PHOTO CAROUSEL (only if photos exist beyond the hero) -->
  <% if @space.photos.attached? && @space.photos.count > 1 %>
    <div class="card gallery">
      <div class="card-body">
        <div class="section-title">Photos</div>
        <div class="gallery-strip">
          <% @space.photos.each_with_index do |ph, idx| %>
            <% next if idx == 0 %> <%# le 1er est utilisé pour le hero %>
            <div class="photo">
              <%= image_tag ph, alt: "#{@space.name} photo #{idx+1}" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <div class="grid">
    <!-- MAIN -->
    <div>
      <div class="card">
        <div class="card-body">
          <div class="section-title">À propos de cet espace</div>
          <p class="muted"><%= @space.description.presence || "Description non renseignée." %></p>

          <div class="info-row" style="margin-top:8px;">
            <% if @space.capacity.present? %><span class="pill"><strong><%= @space.capacity %></strong> personnes max.</span><% end %>
            <% if @space.try(:surface).present? %><span class="pill"><strong><%= @space.surface %> m²</strong> (indicatif)</span><% end %>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <div class="card-body">
          <div class="section-title">Équipements</div>
          <p class="muted">
            <% if @space.respond_to?(:amenities) && @space.amenities.present? %>
              <%= Array(@space.amenities).join(" · ") %>
            <% else %>
              Informations sur les équipements non renseignées.
            <% end %>
          </p>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <div class="card-body">
          <div class="section-title">Emplacement</div>
          <div id="space-map"></div>
        </div>
      </div>
    </div>

    <!-- ASIDE -->
    <aside>
      <div class="card">
        <div class="card-body">
          <div class="price">
            <%= (@space.price_per_hour.presence || 25).to_i %>€
            <span class="muted" style="font-weight:600">/ heure</span>
          </div>
          <div class="muted" style="margin-top:2px;">Journée ~ <%= ((@space.price_per_hour.to_f.presence || 25.0)*8).round %>€</div>

          <form style="margin-top:14px;">
            <label class="muted">Date</label>
            <input type="date" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin:6px 0 10px;">

            <div style="display:flex; gap:10px;">
              <div style="flex:1">
                <label class="muted">Début</label>
                <select style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-top:6px;">
                  <option>09:00</option><option>10:00</option><option>11:00</option><option>14:00</option><option>18:00</option>
                </select>
              </div>
              <div style="flex:1">
                <label class="muted">Fin</label>
                <select style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-top:6px;">
                  <option>12:00</option><option>13:00</option><option>16:00</option><option>19:00</option><option>21:00</option>
                </select>
              </div>
            </div>

            <label class="muted" style="display:block;margin-top:10px;">Participants</label>
            <input type="number" min="1" value="10" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin:6px 0 12px;">

            <button type="button"
                    style="width:100%;padding:12px;border:none;border-radius:10px;background:#2e7d32;color:#fff;font-weight:700;">
              Réserver
            </button>
          </form>

          <div class="contact" style="margin-top:14px;">
            <div class="section-title" style="margin-bottom:8px;">Contacter l’hôte</div>
            <% email = @space.try(:contact_email).presence || "contact@#{@space.name.parameterize}.fr" %>
            <% phone = @space.try(:contact_phone).presence || "+33 6 12 34 56 78" %>
            <div class="info-row"><span class="muted">Email :</span>&nbsp;<a href="mailto:<%= email %>"><%= email %></a></div>
            <div class="info-row"><span class="muted">Téléphone :</span>&nbsp;<a href="tel:<%= phone.gsub(/\s+/,'') %>"><%= phone %></a></div>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var lat = <%= @space.latitude.present? ? @space.latitude : 48.6921 %>;
    var lng = <%= @space.longitude.present? ? @space.longitude : 6.1844 %>;
    var mapEl = document.getElementById('space-map');
    if (!mapEl) return;

    var map = L.map('space-map').setView([lat, lng], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    var marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup("<strong><%= j @space.name %></strong><br><%= j(@space.address || '') %>");
  });
</script>



